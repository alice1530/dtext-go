<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .page_title }}</title>
	<style>
		 body {margin: 0;background: #ebeef1;}.container {position: absolute;top: 20px;right: 20px;bottom: 20px;left: 20px;}.content {font-size: 100%;margin: 0;padding: 20px;overflow-y: auto;resize: none;width: 100%;height: 100%;min-height: 100%;box-sizing: border-box;border: 1px #ddd solid;outline: none;white-space: pre-wrap;word-break: break-all;}@media (prefers-color-scheme: dark) {body {background: #383934;}.content {background: #282923;color: #f8f8f2;border: 0;}}@media print {.container {display: none;}}
	</style>
</head>
<body>
    <div class="container">
        <textarea id="content" class="content">{{ .page_content }}</textarea>
        <script >
				function uploadContent() {
					if (content !== textarea.value) {
						var temp = textarea.value;
						var request = new XMLHttpRequest();
						request.open('POST', window.location.href, true);
						//console.log(window.location.href)
						request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
						request.onload = function() {
							if (request.readyState === 4) {
								content = temp;
								setTimeout(uploadContent, timeout);
							}
						}
						request.onerror = function() {
							setTimeout(uploadContent, timeout);
						}
						request.send('msg=' + encodeURIComponent(temp));
					}
					else {
						setTimeout(uploadContent, timeout);
					}
				}
				var timeout = 5000;
				var textarea = document.getElementById('content');
				var content = textarea.value;
				textarea.onkeydown =  () => {
				  if(event.code !== "Tab") return true;
				  console.log('on key down: ', event.code)
				  event.preventDefault();
				  let start = this.selectionStart;
				  let end = this.selectionEnd;
				  if(start === end){
					document.execCommand('insertText',false,"  ");
				  }else{
					let strBefore = this.value.slice(0,start);
					let curLineStart = strBefore.includes('\n')?strBefore.lastIndexOf('\n')+1 : 0;
					let strBetween = this.value.slice(curLineStart,end+1);
					let newStr = "  " + strBetween.replace(/\n/g,'\n  ');
					let lineBreakCount = strBetween.split('\n').length;
					let newStart = start + 2;
					let newEnd = end + (lineBreakCount + 1)*2;

					this.setSelectionRange(curLineStart,end);
					document.execCommand("insertText",false,newStr);
					this.setSelectionRange(newStart,newEnd);
				  }
				}
			textarea.onblur=()=>{
				event.preventDefault();
				uploadContent();
			}
			textarea.focus();
			uploadContent();
		</script>
    </div>
</body>
</html>